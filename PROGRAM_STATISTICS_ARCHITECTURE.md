# Архитектура системы статистики программы мероприятий

## Полный цикл данных

### 1. Google Sheets → Парсинг → UI (отображение пользователю)

**Файл**: `src/utils/googleSheetsParser.ts`

**Процесс**:
- Загружает CSV из Google Sheets через API экспорта
- Детектирует залы по паттерну колонок: `[время_начала][время_конца][текст][фото?]`
- **ВАЖНО**: Название зала собирается из НЕСКОЛЬКИХ колонок (headerName, строки 378-386)
- **ИСКЛЮЧЕНИЯ**: Колонки 6 и 7 пропускаются при формировании названия зала (EXCLUDED_HEADER_COLS)
- Формат ID сессии: `ДАТА|НАЗВАНИЕ_ЗАЛА|ВРЕМЯ_НАЧАЛА|ВРЕМЯ_КОНЦА`
  - Пример: `"28.10.2025-29.10.2025|ЗАЛ MORRISON|17:40|18:15"`

**Откуда берётся дата**:
```typescript
const metaDate = metaFromSheet['date'] || String(rows[1]?.[0] || '').trim();
```

---

### 2. Пользователь добавляет сессию в план

**Файлы**: 
- `src/pages/WebProgram.tsx` (строки 347-364, 309-327)
- `src/pages/MobileProgram.tsx` (строки 251-280)

**Процесс**:
- Пользователь нажимает "Добавить в план"
- `session.id` сохраняется в localStorage
- **Отправляется на backend**: `POST /save-plan` с массивом `sessionIds`
- **Формат ID**: точно такой же как сгенерировал googleSheetsParser.ts

---

### 3. Backend сохраняет статистику

**Файлы**:
- `backend/save-plan/index.py` - сохраняет план пользователя и обновляет счётчики
- `backend/get-stats/index.py` - возвращает статистику по сессиям

**База данных**:
```sql
session_stats (
  event_id TEXT,
  session_id TEXT,  -- ← Формат: "ДАТА|ЗАЛ|НАЧАЛО|КОНЕЦ"
  interest_count INTEGER
)
```

**ВАЖНО**: `session_id` хранится точно в том же формате, что пришёл с frontend!

---

### 4. ProgramSettings.tsx - выгрузка CSV

**Файл**: `src/pages/ProgramSettings.tsx`

**Задача**: Сопоставить статистику с данными из Google Sheets и создать CSV.

**Текущая проблема**:
- ❌ Парсит таблицу примитивно (фиксированные колонки по 3 штуки)
- ❌ Берёт название зала из ОДНОЙ колонки вместо нескольких
- ❌ НЕ учитывает EXCLUDED_HEADER_COLS
- ❌ ID не совпадают с ID из статистики

**Решение**:
- ✅ Скопировать логику детекции залов из googleSheetsParser.ts
- ✅ Использовать функцию `headerName(c1, c2)` для названия зала
- ✅ Учитывать EXCLUDED_HEADER_COLS
- ✅ Генерировать ID точно так же: `metaDate + '|' + hallName + '|' + start + '|' + end`

---

## Формат ID на каждом этапе

| Этап | Формат | Пример |
|------|--------|--------|
| googleSheetsParser.ts | `ДАТА\|ЗАЛ\|НАЧАЛО\|КОНЕЦ` | `28.10.2025-29.10.2025\|ЗАЛ MORRISON\|17:40\|18:15` |
| WebProgram/MobileProgram | тот же | тот же |
| Backend (база данных) | тот же | тот же |
| get-stats (ответ) | тот же | тот же |
| ProgramSettings CSV парсер | **ДОЛЖЕН БЫТЬ** тот же | **ДОЛЖЕН БЫТЬ** тот же |

---

## Ключевые моменты

1. **Название зала** собирается из нескольких колонок таблицы
2. **Колонки 6 и 7** исключаются при формировании названия
3. **Дата** берётся из `rows[1][0]` или листа Meta
4. **ID** используется ВЕЗДЕ одинаковый - это ключ для сопоставления

---

## Что нужно исправить

В `ProgramSettings.tsx` (строки 214-276) заменить парсинг на:

1. Скопировать константы:
   - `EXCLUDED_HEADER_COLS`
   - `START_ROW = 5`

2. Скопировать функции:
   - `headerName(c1, c2, rows)` - собирает название из нескольких колонок
   - `normalizeTime(v)` - нормализует время

3. Скопировать логику детекции залов:
   - Ищет пары колонок со временем
   - Определяет textCol (может быть +2 или +3)
   - Формирует название зала через headerName()

4. Генерировать ID точно так же:
   ```typescript
   const id = metaDate + '|' + hall.name + '|' + timeStart + '|' + timeEnd;
   ```

Только так ID из статистики совпадут с ID из CSV парсера!
